<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicine Categories - Pharmacy Pro</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom Style -->
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>

    <!-- Sidebar placeholder -->
    <div id="sidebar-container"></div>

    <!-- Mobile Toggle and Overlay -->
    <button class="mobile-toggle" id="mobileToggle">
        <i class="fas fa-bars"></i>
    </button>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="main-wrapper">
        <header class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h2 class="fw-bold m-0">Medicine Categories</h2>
                <p class="text-muted">Manage categories for better inventory organization</p>
            </div>
            <div>
                <button class="btn btn-primary d-flex align-items-center gap-2" data-bs-toggle="modal"
                    data-bs-target="#addCategoryModal">
                    <i class="fas fa-plus"></i> Add Category
                </button>
            </div>
        </header>

        <div class="card p-0 border-0 shadow-sm overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4 py-3">ID</th>
                            <th class="py-3">Category Name</th>
                            <th class="py-3">Created At</th>
                            <th class="text-end pe-4 py-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="categoryTableBody">
                        <tr>
                            <td colspan="4" class="text-center py-5">
                                <span class="spinner-border spinner-border-sm text-primary"></span> Loading
                                categories...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0">
                    <h5 class="fw-bold m-0">Add New Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCategoryForm">
                        <div class="mb-3">
                            <label class="form-label fw-medium">Category Name</label>
                            <input type="text" class="form-control" id="newCategoryName" placeholder="e.g. Antibiotics"
                                required>
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary px-4" id="saveCategoryBtn">Save
                                Category</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div class="modal fade" id="editCategoryModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0">
                    <h5 class="fw-bold m-0">Edit Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCategoryForm">
                        <input type="hidden" id="editCategoryId">
                        <div class="mb-3">
                            <label class="form-label fw-medium">Category Name</label>
                            <input type="text" class="form-control" id="editCategoryName" required>
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary px-4">Update Category</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/api.js"></script>
    <script>
        let addModal, editModal;

        async function initCategories() {
            try {
                // Initialize Sidebar
                await api.loadSidebar('categories');

                addModal = new bootstrap.Modal(document.getElementById('addCategoryModal'));
                editModal = new bootstrap.Modal(document.getElementById('editCategoryModal'));

                loadCategories();

                // Form Submissions
                document.getElementById('addCategoryForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('newCategoryName').value;
                    try {
                        const res = await api.post('/categories', { category_name: name });
                        if (res.success) {
                            api.showNotification("Category added successfully");
                            addModal.hide();
                            document.getElementById('addCategoryForm').reset();
                            loadCategories();
                        }
                    } catch (err) { api.showNotification(err.message, 'error'); }
                });

                document.getElementById('editCategoryForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const id = document.getElementById('editCategoryId').value;
                    const name = document.getElementById('editCategoryName').value;
                    try {
                        const res = await api.put(`/categories/${id}`, { category_name: name });
                        if (res.success) {
                            api.showNotification("Category updated successfully");
                            editModal.hide();
                            loadCategories();
                        }
                    } catch (err) { api.showNotification(err.message, 'error'); }
                });

            } catch (err) { console.error("Category page error:", err); }
        }

        async function loadCategories() {
            const tableBody = document.getElementById('categoryTableBody');
            try {
                const res = await api.get('/categories');
                const categories = res.data;

                if (categories.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-5">No categories found.</td></tr>';
                    return;
                }

                tableBody.innerHTML = categories.map(cat => `
                    <tr>
                        <td class="ps-4"><span class="fw-medium text-muted">#${cat.category_id}</span></td>
                        <td><span class="fw-bold">${cat.category_name}</span></td>
                        <td>${new Date(cat.created_at).toLocaleDateString('en-IN')}</td>
                        <td class="text-end pe-4">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="openEditModal(${cat.category_id}, '${cat.category_name}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${cat.category_id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-5 text-danger">${err.message}</td></tr>`;
            }
        }

        window.openEditModal = (id, name) => {
            document.getElementById('editCategoryId').value = id;
            document.getElementById('editCategoryName').value = name;
            editModal.show();
        }

        window.deleteCategory = async (id) => {
            if (await api.confirm('Are you sure you want to delete this category? This might affect medicines linked to it.')) {
                try {
                    await api.delete(`/categories/${id}`);
                    api.showNotification("Category deleted successfully");
                    loadCategories();
                } catch (err) { api.showNotification(err.message, 'error'); }
            }
        }

        initCategories();
    </script>
</body>

</html>