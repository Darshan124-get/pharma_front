<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Pharmacy Pro</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom Style -->
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>

    <!-- Sidebar placeholder -->
    <div id="sidebar-container"></div>

    <!-- Mobile Toggle and Overlay -->
    <button class="mobile-toggle" id="mobileToggle">
        <i class="fas fa-bars"></i>
    </button>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="main-wrapper">
        <header class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h2 class="fw-bold m-0">User Management</h2>
                <p class="text-muted">Manage staff accounts and permissions</p>
            </div>
            <div>
                <button class="btn btn-primary d-flex align-items-center gap-2" data-bs-toggle="modal"
                    data-bs-target="#addUserModal">
                    <i class="fas fa-user-plus"></i> Add New User
                </button>
            </div>
        </header>

        <div class="card p-0 border-0 shadow-sm overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4 py-3">User</th>
                            <th class="py-3">Role</th>
                            <th class="py-3">Contact</th>
                            <th class="py-3">Joined</th>
                            <th class="text-end pe-4 py-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <span class="spinner-border spinner-border-sm text-primary"></span> Loading users...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 pb-0">
                    <h5 class="fw-bold m-0">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label small fw-bold">Full Name</label>
                                <input type="text" class="form-control" name="full_name" placeholder="Enter name"
                                    required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Email Address</label>
                                <input type="email" class="form-control" name="email" placeholder="email@example.com"
                                    required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Phone (Optional)</label>
                                <input type="text" class="form-control" name="phone" placeholder="e.g. 9876543210">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" name="password" id="addPassword"
                                        required>
                                    <span class="input-group-text bg-white" style="cursor: pointer;"
                                        onclick="togglePassword('addPassword', this)">
                                        <i class="fas fa-eye"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Role</label>
                                <select class="form-select" name="role" required>
                                    <option value="staff" selected>Staff / Subadmin</option>
                                    <option value="admin">Administrator</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label small fw-bold">Profile Image</label>
                                <input type="file" class="form-control" name="image" accept="image/*">
                            </div>
                        </div>
                        <div class="text-end mt-4 pt-3 border-top">
                            <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary px-4">Create Account</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 pb-0">
                    <h5 class="fw-bold m-0">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label small fw-bold">Full Name</label>
                                <input type="text" class="form-control" id="editFullName" name="full_name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Email Address</label>
                                <input type="email" class="form-control" id="editEmail" name="email" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Phone</label>
                                <input type="text" class="form-control" id="editPhone" name="phone">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Role</label>
                                <select class="form-select" id="editRole" name="role" required>
                                    <option value="staff">Staff / Subadmin</option>
                                    <option value="admin">Administrator</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">New Password (optional)</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="editPassword" name="password"
                                        placeholder="Leave blank to keep current">
                                    <span class="input-group-text bg-white" style="cursor: pointer;"
                                        onclick="togglePassword('editPassword', this)">
                                        <i class="fas fa-eye"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label small fw-bold">Profile Image</label>
                                <input type="file" class="form-control" name="image" accept="image/*">
                            </div>
                        </div>
                        <div class="text-end mt-4 pt-3 border-top">
                            <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary px-4">Update Account</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/api.js"></script>
    <script>
        let addModal, editModal;

        async function initUsers() {
            try {
                // Initialize Sidebar
                await api.loadSidebar('users');

                addModal = new bootstrap.Modal(document.getElementById('addUserModal'));
                editModal = new bootstrap.Modal(document.getElementById('editUserModal'));

                loadUsers();

                // Form Submissions
                document.getElementById('addUserForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = e.target.querySelector('button[type="submit"]');
                    const originalText = btn.innerHTML;

                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData.entries());

                    try {
                        btn.disabled = true;
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';

                        const res = await api.post('/auth/users', formData);
                        if (res.success) {
                            api.showNotification('User account created successfully');
                            addModal.hide();
                            e.target.reset();
                            loadUsers();
                        }
                    } catch (err) {
                        api.showNotification(err.message, 'error');
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                });

                document.getElementById('editUserForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = e.target.querySelector('button[type="submit"]');
                    const originalText = btn.innerHTML;

                    const id = document.getElementById('editUserId').value;
                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData.entries());

                    // Remove empty password
                    if (!data.password) delete data.password;

                    try {
                        btn.disabled = true;
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';

                        const res = await api.put(`/auth/users/${id}`, formData);
                        if (res.success) {
                            api.showNotification('User account updated successfully');
                            editModal.hide();
                            loadUsers();
                        }
                    } catch (err) {
                        api.showNotification(err.message, 'error');
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                });

            } catch (err) { console.error("User page error:", err); }
        }

        async function loadUsers() {
            const tableBody = document.getElementById('userTableBody');
            try {
                const res = await api.get('/auth/users');
                const users = res.data;

                if (users.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-5">No users found.</td></tr>';
                    return;
                }

                tableBody.innerHTML = users.map(user => {
                    const isSelf = user.user_id === JSON.parse(localStorage.getItem('user')).user_id;
                    const roleBadge = user.role === 'admin'
                        ? '<span class="badge bg-primary bg-opacity-10 text-primary">Administrator</span>'
                        : '<span class="badge bg-info bg-opacity-10 text-info">Staff / Subadmin</span>';

                    // Handle null or "None" string from backend
                    const avatarUrl = (user.image_url && user.image_url !== 'None') ? user.image_url : null;

                    return `
                    <tr>
                        <td class="ps-4">
                            <div class="d-flex align-items-center gap-2">
                                <div class="avatar-sm bg-light rounded-circle d-flex align-items-center justify-content-center overflow-hidden" style="width:32px; height:32px;">
                                    ${avatarUrl ?
                            `<img src="${avatarUrl}" style="width:100%; height:100%; object-fit:cover;" onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\'fas fa-user-circle text-muted\'></i>'">` :
                            '<i class="fas fa-user-circle text-muted"></i>'
                        }
                                </div>
                                <div>
                                    <div class="fw-bold">${user.full_name} ${isSelf ? '<span class="text-muted small">(You)</span>' : ''}</div>
                                    <div class="x-small text-muted">${user.email}</div>
                                </div>
                            </div>
                        </td>
                        <td>${roleBadge}</td>
                        <td>${user.phone || '-'}</td>
                        <td class="small">${new Date(user.created_at).toLocaleDateString('en-IN')}</td>
                        <td class="text-end pe-4">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="openEditModal(${JSON.stringify(user).replace(/"/g, '&quot;')})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${!isSelf ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.user_id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `}).join('');
            } catch (err) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-5 text-danger">${err.message}</td></tr>`;
            }
        }

        window.openEditModal = (user) => {
            document.getElementById('editUserId').value = user.user_id;
            document.getElementById('editFullName').value = user.full_name;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editPhone').value = user.phone || '';
            document.getElementById('editRole').value = user.role;
            document.getElementById('editPassword').value = '';
            editModal.show();
        }

        window.deleteUser = async (id) => {
            if (await api.confirm('Are you sure you want to delete this user account? This action cannot be undone.')) {
                try {
                    await api.delete(`/auth/users/${id}`);
                    api.showNotification('User deleted successfully');
                    loadUsers();
                } catch (err) { api.showNotification(err.message, 'error'); }
            }
        }

        initUsers();
    </script>
</body>

</html>