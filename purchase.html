<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase - Pharmacy Pro</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom Style -->
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>

    <div id="sidebar-container"></div>

    <div class="main-wrapper">
        <header class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h2 class="fw-bold m-0">Purchase Entry</h2>
                <p class="text-muted">Record new stock arrivals and update inventory</p>
            </div>
            <div>
                <a href="medicines.html" class="btn btn-outline-primary"><i class="fas fa-pills"></i> Check Stock</a>
            </div>
        </header>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card p-4">
                    <h5 class="fw-bold mb-4">Stock Details</h5>
                    <form id="purchaseForm">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Select Supplier</label>
                                <select class="form-select" id="supplierSelect" name="supplier_id" required>
                                    <option value="">Loading suppliers...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Invoice Number</label>
                                <input type="text" class="form-control" name="invoice_number" required>
                            </div>
                        </div>

                        <div class="table-responsive mb-4">
                            <table class="table table-bordered">
                                <thead class="bg-light">
                                    <tr>
                                        <th style="width: 40%;">Medicine</th>
                                        <th>Quantity</th>
                                        <th>Unit Price</th>
                                        <th class="text-end">Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="purchaseTableBody">
                                    <!-- Dynamic rows -->
                                </tbody>
                            </table>
                        </div>

                        <button type="button" class="btn btn-outline-primary btn-sm mb-4" onclick="addPurchaseRow()">
                            <i class="fas fa-plus"></i> Add Item
                        </button>

                        <div class="row justify-content-end">
                            <div class="col-md-4">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Subtotal</span>
                                    <span id="subtotalVal">₹ 0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-4 border-top pt-2">
                                    <h5 class="fw-bold">Net Amount</h5>
                                    <h5 class="fw-bold text-primary" id="netAmountVal">₹ 0.00</h5>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-3" id="submitBtn">FINALIZE PURCHASE
                            ENTRY</button>
                    </form>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card p-4">
                    <h5 class="fw-bold mb-4">Recent Purchases</h5>
                    <div id="recentPurchases" class="list-group list-group-flush">
                        <!-- Loaded via JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/api.js"></script>
    <script>
        let medicines = [];
        let rowCount = 0;

        async function initPage() {
            await api.loadSidebar('purchase');

            // Load base data
            const [supRes, medRes, purRes] = await Promise.all([
                api.get('/suppliers'),
                api.get('/medicines'),
                api.get('/purchases')
            ]);

            medicines = medRes.data;
            populateSuppliers(supRes.data);
            renderRecentPurchases(purRes.data);
            addPurchaseRow(); // Start with one row
        }

        function populateSuppliers(suppliers) {
            const select = document.getElementById('supplierSelect');
            select.innerHTML = '<option value="">-- Choose Supplier --</option>' +
                suppliers.map(s => `<option value="${s.supplier_id}">${s.supplier_name}</option>`).join('');
        }

        function addPurchaseRow() {
            rowCount++;
            const tbody = document.getElementById('purchaseTableBody');
            const tr = document.createElement('tr');
            tr.id = `row-${rowCount}`;
            tr.innerHTML = `
                <td>
                    <select class="form-select med-select" name="medicine_id" onchange="calculateRow(${rowCount})" required>
                        <option value="">-- Select --</option>
                        ${medicines.map(m => `<option value="${m.medicine_id}">${m.medicine_name}</option>`).join('')}
                    </select>
                </td>
                <td><input type="number" class="form-control qty-input" name="quantity" oninput="calculateRow(${rowCount})" required></td>
                <td><input type="number" step="0.01" class="form-control price-input" name="purchase_price" oninput="calculateRow(${rowCount})" required></td>
                <td class="text-end fw-bold"><span class="row-total">0.00</span></td>
                <td class="text-center"><button type="button" class="btn btn-sm text-danger" onclick="removeRow(${rowCount})"><i class="fas fa-times"></i></button></td>
            `;
            tbody.appendChild(tr);
        }

        function calculateRow(id) {
            const tr = document.getElementById(`row-${id}`);
            const qty = parseFloat(tr.querySelector('.qty-input').value) || 0;
            const price = parseFloat(tr.querySelector('.price-input').value) || 0;
            const total = qty * price;
            tr.querySelector('.row-total').textContent = total.toFixed(2);
            updateGrandTotal();
        }

        function updateGrandTotal() {
            let grand = 0;
            document.querySelectorAll('.row-total').forEach(el => grand += parseFloat(el.textContent));
            document.getElementById('subtotalVal').textContent = `₹ ${grand.toFixed(2)}`;
            document.getElementById('netAmountVal').textContent = `₹ ${grand.toFixed(2)}`;
        }

        function removeRow(id) {
            if (document.querySelectorAll('#purchaseTableBody tr').length > 1) {
                document.getElementById(`row-${id}`).remove();
                updateGrandTotal();
            }
        }

        function renderRecentPurchases(purchases) {
            const container = document.getElementById('recentPurchases');
            if (purchases.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-muted small">No recent purchases</div>';
                return;
            }

            container.innerHTML = purchases.slice(0, 10).map(p => {
                const isPending = p.status === 'pending';
                const statusBadge = isPending
                    ? '<span class="badge bg-warning text-dark x-small">Pending</span>'
                    : '<span class="badge bg-success x-small">Received</span>';

                return `
                <div class="list-group-item px-0">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small fw-bold">#${p.invoice_number}</span>
                        <span class="x-small text-muted">${new Date(p.purchase_date).toLocaleDateString()}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="small d-block text-truncate" style="max-width: 150px;">${p.supplier_name}</span>
                            ${statusBadge}
                        </div>
                        <div class="text-end">
                            <span class="small fw-bold d-block">₹ ${p.total_amount}</span>
                            ${isPending ? `
                                <button class="btn btn-sm btn-primary py-0 x-small mt-1" onclick="receivePurchase(${p.purchase_id})">
                                    Receive
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        window.receivePurchase = async (id) => {
            if (await api.confirm('Are you sure you have received these items? This will update your inventory stock.')) {
                try {
                    const res = await api.post(`/purchases/${id}/receive`);
                    if (res.success) {
                        api.showNotification("Items received and stock updated!");
                        setTimeout(() => location.reload(), 1500);
                    }
                } catch (err) { api.showNotification(err.message, 'error'); }
            }
        }

        document.getElementById('purchaseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const data = {
                supplier_id: parseInt(document.getElementById('supplierSelect').value),
                invoice_number: e.target.invoice_number.value,
                total_amount: parseFloat(document.getElementById('netAmountVal').textContent.replace('₹ ', '')),
                purchase_date: new Date().toISOString().split('T')[0],
                items: []
            };

            document.querySelectorAll('#purchaseTableBody tr').forEach(tr => {
                data.items.push({
                    medicine_id: parseInt(tr.querySelector('.med-select').value),
                    quantity: parseInt(tr.querySelector('.qty-input').value),
                    purchase_price: parseFloat(tr.querySelector('.price-input').value),
                    total_price: parseFloat(tr.querySelector('.row-total').textContent)
                });
            });

            btn.disabled = true;
            try {
                await api.post('/purchases', data);
                api.showNotification("Purchase order created! Remember to click 'Receive' when items arrive to update stock.", "info");
                setTimeout(() => location.reload(), 2000);
            } catch (err) { api.showNotification(err.message, 'error'); btn.disabled = false; }
        });


        initPage();
    </script>
</body>

</html>